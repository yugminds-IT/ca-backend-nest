service: nest-backend-caa

useDotenv: true

plugins:
  - serverless-dotenv-plugin
  - serverless-offline

provider:
  name: aws
  runtime: nodejs20.x
  region: ${env:AWS_REGION, 'ap-south-1'}
  stage: ${opt:stage, 'dev'}
  memorySize: 512
  timeout: 30
  environment:
    NODE_ENV: ${env:NODE_ENV, 'development'}
    DATABASE_URL: ${env:DATABASE_URL}
    SECRET_KEY: ${env:SECRET_KEY}
    JWT_SECRET: ${env:JWT_SECRET, env:SECRET_KEY}
    ALGORITHM: ${env:ALGORITHM, 'HS256'}
    ACCESS_TOKEN_EXPIRE_MINUTES: ${env:ACCESS_TOKEN_EXPIRE_MINUTES, '60'}
    REFRESH_TOKEN_EXPIRE_DAYS: ${env:REFRESH_TOKEN_EXPIRE_DAYS, '7'}
    CORS_ORIGINS: ${env:CORS_ORIGINS, ''}
    SMTP_HOST: ${env:SMTP_HOST, ''}
    SMTP_PORT: ${env:SMTP_PORT, '465'}
    SMTP_USER: ${env:SMTP_USER, ''}
    SMTP_PASS: ${env:SMTP_PASS, ''}
    SMTP_FROM: ${env:SMTP_FROM, ''}
    SMTP_SECURE: ${env:SMTP_SECURE, 'true'}
    FRONTEND_URL: ${env:FRONTEND_URL, 'http://localhost:3000'}
    AWS_S3_BUCKET: ${env:AWS_S3_BUCKET, ''}
    AWS_S3_BUCKET_NAME: ${env:AWS_S3_BUCKET_NAME, ''}
    AWS_S3_ENDPOINT_URL: ${env:AWS_S3_ENDPOINT_URL, ''}
    AWS_ACCESS_KEY_ID: ${env:AWS_ACCESS_KEY_ID, ''}
    AWS_SECRET_ACCESS_KEY: ${env:AWS_SECRET_ACCESS_KEY, ''}
    DB_SSL: ${env:DB_SSL, 'false'}

functions:
  api:
    handler: dist/src/lambda.handler
    events:
      - httpApi:
          path: /{proxy+}
          method: ANY
      - httpApi:
          path: /
          method: ANY

package:
  patterns:
    - '!src/**'
    - '!test/**'
    - '!*.ts'
    - '!*.map'
    - '!.env*'
    - '!.git/**'
    - '!tsconfig*.json'
    - '!nest-cli.json'
    - '!eslint.config.mjs'

custom:
  serverless-offline:
    httpPort: 3000
    noPrependStageInUrl: true
